{% extends "admin/base.html" %}
{% block content %}

<h4 class="mb-4">Add New Flight</h4>

<form method="POST" class="card p-4">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Airline</label>
            <select name="airline_id" id="airlineSelect" class="form-select" required>
                <option value="">Select Airline</option>
                {% for a in airlines %}
                <option value="{{ a.airline_id }}">
                    {{ a.airline_name }} ({{ a.airline_id }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Flight Number</label>
            <input type="text" name="flight_number" class="form-control" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Aircraft</label>
            <select name="aircraft_id" id="aircraftSelect" class="form-select" required>
                <option value="">Select Aircraft</option>
            </select>
            <small class="text-muted">You need to have at least 1 registered aircraft per airline.</small>
        </div>

        <div class="col-md-6">
            <label class="form-label">Departure Airport</label>
            <select name="departure_airport_id" class="form-select" required>
                {% for ap in airports %}
                    <option value="{{ ap.airport_id }}">
                        {{ ap.airport_id }} – {{ ap.airport_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">Arrival Airport</label>
            <select name="arrival_airport_id" class="form-select" required>
                {% for ap in airports %}
                    <option value="{{ ap.airport_id }}">
                        {{ ap.airport_id }} – {{ ap.airport_name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Departure Time</label>
            <input type="time" name="departure_time" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label class="form-label">Arrival Time</label>
            <input type="time" name="arrival_time" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label class="form-label">Departure Terminal</label>
            <input type="text" name="departure_terminal" class="form-control">
        </div>

        <div class="col-md-3">
            <label class="form-label">Arrival Terminal</label>
            <input type="text" name="arrival_terminal" class="form-control">
        </div>

        <div class="row mt-3">
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" name="start_date" class="form-control" required>
                <small class="text-muted">First date this schedule runs</small>
            </div>
            <div class="col-md-3">
                <label class="form-label">Recurrence</label>
                <select name="recurrence" class="form-select" required>
                    <option value="1">Once</option>
                    <option value="3">3 days</option>
                    <option value="7">7 days</option>
                    <option value="30">30 days</option>
                </select>
            </div>
        </div>

        <div class="col-md-12">
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="direct" value="1" checked disabled>
                <label class="form-check-label">Direct Flight</label>
            </div>
        </div>
    </div>

    <hr class="my-4">
    <h5>Fare Configuration</h5>
    <div class="row g-3">
        {% for cls in ['ECONOMY', 'BUSINESS', 'FIRST'] %}
        <div class="col-md-4">
            <div class="card p-3">
                <h6>{{ cls }}</h6>
                <label class="form-label">Price</label>
                <input type="number" name="price_{{ cls }}" class="form-control" required>

                <label class="form-label mt-2">Checked Baggage (kg)</label>
                <input type="number" name="baggage_{{ cls }}" class="form-control" required>

                <label class="form-label mt-2">Cabin Baggage (kg)</label>
                <input type="number" name="cabin_{{ cls }}" class="form-control" required>

                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" name="refundable_{{ cls }}">
                    <label class="form-check-label">Refundable</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="reschedulable_{{ cls }}">
                    <label class="form-check-label">Reschedulable</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="meal_{{ cls }}">
                    <label class="form-check-label">Meal Included</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="entertainment_{{ cls }}">
                    <label class="form-check-label">Entertainment</label>
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="wifi_{{ cls }}">
                    <label class="form-check-label">Wi-Fi</label>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="mt-4 text-end">
        <a href="{{ url_for('admin_view_flight') }}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Create Flight</button>
    </div>
</form>

<script>
    document.getElementById("airlineSelect").addEventListener("change", function () {
        const airlineId = this.value;
        const aircraftSelect = document.getElementById("aircraftSelect");

        aircraftSelect.innerHTML = '<option value="">Select Aircraft</option>';
        aircraftSelect.disabled = true;

        if (!airlineId) return;

        fetch(`/admin/api/aircrafts/${airlineId}`)
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) return;

                data.forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.aircraft_id;
                    opt.textContent = `${a.model} (${a.seat_layout})`;
                    aircraftSelect.appendChild(opt);
                });

                aircraftSelect.disabled = false;
            })
            .catch(() => {
                alert("Failed to load aircraft list.");
            });
    });
</script>

{% endblock %}
